
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Challenge</title>
	
  <!-- Chart.js library   background-color: yellow; -->
  <script  src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="style.css">


  <!-- Import navbar and footer components -->
  <link rel="import" href="/elements/navbar.html">
  <link rel="import" href="/elements/footer.html">

  <div id="navbar"></div>
  <!-- Rest of the page content -->
  <div id="signupLoginArea"><div>

  <!-- JavaScript dependencies async -->


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"  crossorigin="anonymous">


  <script  defer src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.9.3/umd/popper.min.js"></script>

  <script  defer src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

	  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css">
	  <script  defer src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.0.2/js/bootstrap.min.js"></script>

  <!-- Firebase SDK -->
  <script  src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script  src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script  src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <!-- Custom scripts   <script  src="/main.js" defer></script> 
-->
  <script  src="/main.js" ></script> 
 <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    header {
      text-align: center;
      background-color: #007bff;
      color: #fff;
      padding: 10px;
    }

    section {
      margin: 20px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #f9f9f9;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }

    h2 {
      margin-top: 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      border: 1px solid #ddd;
    }

    table, th, td {
      border: 1px solid #ddd;
    }

    th, td {
      padding: 8px;
      text-align: left;
    }

    .btnMain {
      background-color: #fd7e14;
      color: white;
      border: none;
      border-radius: 1em;
      padding: 2%;
      font-size: calc(1rem + 2vw);
      font-weight: 600;
      margin-top: 20px;
      margin-bottom: 15%;
      text-shadow: -4px 2px 0px #6b6a6a;
      box-shadow: 3px 3px 0rem 3px #b98c03 !important;
      cursor: pointer;
      text-align: center;
    }

    button:hover {
      background-color: #f25900;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    li {
      margin-bottom: 10px;
    }

    a {
      text-decoration: none;
      color: #007bff;
    }

    a:hover {
      color: #0056b3;
    }



	  
.friends{
cursor: pointer;
font-size: 1.5em;
    font-weight: 500;
	width: 100%;
    color: #000;
    display: flex;
    justify-content: space-around;
    background-color: white;
    border: 1px solid #ced4da;
    border-radius: 4px;
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
    margin: 2% 0;
}
	  .picArea{
    border: 1px solid #fd7e14;
    border-radius: 5em;
    padding: 1%;
    overflow: hidden;
	  }

	  .points{
      font-weight: 800;
    margin: auto;
    width: 50%;
	  }
	  .remove{
    border: 1px solid #fd7e14;
    border-radius: 5px;
    padding: 1%;
    color: #fff;
    background-color: red;
    margin: auto;
    width: 20%;	  
		  display:block;
	  }

	  .bg{
    border: 1px solid #ebebeb;
    border-radius: 1em;
    background-color: #f5f5f5;
    margin: 1%;
    width: 95%;
    display: flex;
    padding: 2%	  
	  }

	  .picWrap{
    width: 20%;
}
	 .picArea img {
    width: 100%;
    height: 100%;
}

#friendsChallengeList{
    width: 100%;
    display: grid;
    margin: 0;
    padding: 0;
}
	 
  </style>

    
  </head>
<body>
  <!-- Add your HTML content here -->
  <h1>Quiz Challenge Page</h1>
    <div class="challengeTabMain">
        <button class="tab-button" onclick="openTab('challengeDetails')">Challenge Details</button>
        <button class="tab-button" onclick="openTab('challengeRequests')">Challenge Requests</button>
        <button class="tab-button" onclick="openTab('challengeResults')">Challenge Results</button>
        <button class="tab-button" onclick="openTab('sendChallenge')">Send Challenge</button>
    </div>

  <section id="challengeDetails" class='challengeTab'>
    <h2>Quiz Challenge Details</h2>
    <p>Quiz Code: <span id="quizCode"></span></p>
    <p>Challenge Number: <span id="challengeNumber"></span></p>
    <!-- Display more challenge details here -->
  </section>

  <section id="challengeResults" class='challengeTab'>
    <h2>Quiz Challenge Results</h2>
    <table>
      <thead>
        <tr>
          <th>Question</th>
          <th>Your Answer</th>
          <th>Correct Answer</th>
        </tr>
      </thead>
      <tbody>
        <!-- Display challenge results rows here -->
      </tbody>
    </table>
  </section>

  <section id="challengeRequests" class='challengeTab'>
    <h2>Challenge Requests</h2>
    <ul id="requestsList">
      <!-- Display challenge requests as list items here -->
    </ul>
  </section>

  <section id="sendChallenge" class='challengeTab'>
    <h2>Send Challenge</h2>
    <form id="sendChallengeForm">
    <div id="friendsChallengeList">
      <!-- Display friend list and other form elements here -->
    </div>
      <button class="btnMain" type="submit">Send Challenge</button>
    </form>
  </section>

	

  <script>

function generateUniqueChallengeNumber() {
    const timestamp = new Date().getTime();
    const randomSuffix = Math.floor(Math.random() * 10000); // Generate a random number between 0 and 9999
    return `challenge_${timestamp}_${randomSuffix}`;
}


	  
        function openTab(tabId) {
            const tabContents = document.getElementsByClassName('challengeTab');
            for (const content of tabContents) {
                content.style.display = 'none';
            }
            document.getElementById(tabId).style.display = 'block';
        }

	  
	  //start https://www.quizzatopia.com/challenge/?SPORTS2023&start;

	// request    `https://quizzatopia.com/challenge/?$52jki52&$5215kjjk`;

//https://www.quizzatopia.com/challenge/?ARE_Quiz_Medium_2023&start
  // Function to read URL parameters pathname
  function getURLParams() {
  const pathname = window.location.href;
    return pathname;
  }
document.addEventListener("DOMContentLoaded", function () {
});


        var quizCode = "";
        var challengeNumber = "";
	  
// Function to fetch and display challenge requests
function fetchAndDisplayChallenges(userID) {
 
const pathname = getURLParams();
	
//const pathname = "challenge/?SPORTS2023&start";
	
const startIndex = pathname.indexOf('?') + 1;
	
console.log("pathname:", pathname);
console.log("startIndex:", startIndex);

let quizCode = "";
let challengeNumber = "";

if (startIndex > 0) {
    const endIndex = pathname.indexOf('&', startIndex);

    if (endIndex === -1) {
        quizCode = pathname.substring(startIndex);
    } else {
        quizCode = pathname.substring(startIndex, endIndex);
        
        const lastAmpersandIndex = pathname.indexOf('&', endIndex + 1);

        if (lastAmpersandIndex === -1) {
            challengeNumber = pathname.substring(endIndex + 1);
        } else {
            challengeNumber = pathname.substring(endIndex + 1, lastAmpersandIndex);
        }
    }
}

console.log("quizCodeXXXX:", quizCode);
console.log("challengeNumberXXXXX:", challengeNumber);










	
	
    // Hide elements if necessary
    if (quizCode === "") {
        document.getElementById("challengeDetails").style.display = "none";
	    	    console.log("challengeDetails:");

    }
    
    if (challengeNumber === "") {
        document.getElementById("challengeResults").style.display = "none";
      console.log("challengeResults:");
}

    if (quizCode === "" && challengeNumber === "") {
        document.getElementById("challengeResults").style.display = "none";
        document.getElementById("sendChallenge").style.display = "none";
	    			    console.log("quizCode  && challengeNumber:");

    } else {
        document.getElementById("quizCode").innerHTML = quizCode;
        document.getElementById("challengeNumber").innerHTML = challengeNumber;
    }

    if (quizCode && challengeNumber === "start") {
        document.getElementById("challengeResults").style.display = "none";
        document.getElementById("challengeRequests").style.display = "none";
	      
	    challengeNumber = generateUniqueChallengeNumber(); // Generate a unique challenge number

        document.getElementById("challengeNumber").innerHTML = challengeNumber;
	    
	    			    console.log("challengeResults  && challengeRequests:");

    } 

	
    // Assuming you have a Firebase Firestore instance initialized
    const db = firebase.firestore();
    const challengesContainer = document.getElementById("requestsList");

    // Fetch challenge requests for the current user
    if (quizCode !== "" && challengeNumber !== "") {
        db.collection("challenges")
            .where("challengeNumber", "==", challengeNumber) 
            .where("requesterID", "==", userID)
            .get()
            .then((querySnapshot) => {
                  if (querySnapshot.empty) {
        // If no requests are displayed, start a challenge
        startChallenge(userID);
        return;
      }

      // Create an HTML table for the challenges
      let challengesTable = '<table>';
      challengesTable += '<thead><tr><th>Quiz Name</th><th>Request Date</th><th>Challenger</th><th>Actions</th></tr></thead><tbody>';

      // Iterate through the challenge requests
      querySnapshot.forEach((doc) => {
        const challengeData = doc.data();
        const challengeID = doc.id;

        // Define styles based on requester or challenger
        const cellStyle = challengeData.requesterID === userID ? "sent-cell" : "received-cell";

        // Add a row to the table
        challengesTable += `
          <tr class="${cellStyle}">
            <td>${challengeData.quizName}</td>
            <td>${challengeData.requestDate.toDate().toLocaleString()}</td>
            <td>${challengeData.challengerID}</td>
            <td><button onclick="acceptChallenge('${challengeID}','${challengeData.quizCode}')">Accept</button></td>
          </tr>`;
      });

      challengesTable += '</tbody></table>';

      // Update the challenges container with the table
      challengesContainer.innerHTML = challengesTable;
    })
    .catch((error) => {
                console.error("Error fetching challenges:", error);
            });
    }
}

	    function shareFriendCodeFunc(uID){

const shareLink = `https://www.quizzatopia.com/friends/?${uID}`; // Replace with your actual link

// Check if the navigator.share() API is available
if (navigator.share) {
  const shareData = {
    title: 'Join Quizzatopia - Connect and Compete with Friends through Quizzes!',
    text: 'Explore, challenge, and connect with friends through quizzes on Quizzatopia. Join now for a fun trivia adventure!',
    url: shareLink,
  };

  // Call the navigator.share() method
  navigator.share(shareData)
    .then(() => console.log('Shared successfully'))
    .catch((error) => console.error('Error sharing:', error));
} else {
  // Fallback behavior for browsers that do not support navigator.share()
  console.log('navigator.share() API is not supported in this browser');
  // You can provide alternative sharing options here
  // For example, showing a social media sharing dialog
}
	    }



	  
// Function to accept a challenge
function acceptChallenge(challengeID,quizCode) {
  // Accept the challenge
  // Add your logic here to accept a challenge or display a message
}





























async function getUserFriends(userID) {
  try {
    const { friends, friendData } = await getUserFriendsWithUserData(userID);
	  


 // Clear previous list items
document.getElementById("friendsChallengeList").innerHTML = '';

    // Generate list items for each friend
      let friendsHTML = "";
  friends.forEach((friendFirebaseId) => {
    // Find the friend's data based on the firebaseId
    const friendInfo = friendData.find(data => data.firebaseId === friendFirebaseId);

	  console.log("friendInfo :", friendInfo);

  const friendName = friendInfo.userName;
  let friendPicture = friendInfo.userProfilePic;
  const friendPoints = friendInfo.userPoints;
//  const friendFirebaseId = friendInfo.firebaseId;

  console.log("friendPicture :", friendPicture);

 friendPicture = ensureDomainInUrl(friendPicture);
	    
      // Create an image element with its source set to the friend's picture
      const imgElement = `<img src="${friendPicture}" alt="${friendName}" width="40" height="40">`;

      // Create a span element for the friend's points
      const name = `<span>${friendName}</span>`;
      const points = `<span>${friendPoints}</span>`;

      // Create the list item HTML with the friend's name, picture, and points
      const listItemHTML = `
        <li class='friends' ><div  class='bg' onclick="generateChallengeURL(quizCode, challengeNumber)"> 
        <div  class='picWrap' >
	<div class='picArea'> ${imgElement}</div>
         <div> ${name}</div></div>
         <div> </div>
         <div class='points'>  ${points} Points</div>
         <div class='remove ' onclick=" removeFriend('${friendFirebaseId}');"> &#128465;</div>
	 </div>
        </li>
      `;

      // Concatenate the HTML for each friend
      friendsHTML += listItemHTML;
    });

    // Set the innerHTML of friendsList with the generated HTML
	  document.getElementById("friendsChallengeList").innerHTML = friendsHTML;
	  
const newDiv = document.createElement('div');
newDiv.innerHTML = `<div class='share2' onclick="shareFriendCodeFunc('${uID}')">Send Your Link to Your Friends</div>`;
	
  document.getElementById("friendsChallengeList").appendChild(newDiv);
	  
  } catch (error) {
    console.error('Error fetching friends and user data:', error);
  }
}




	  







// Function to generate a challenge URL
function generateChallengeURL(quizCode, challengeNumber) {
  return `https://quizzatopia.com/challenge/?quizCode=${quizCode}&challengeNumber=${challengeNumber}`;
}

// When the user selects friends and submits the form
document.getElementById("sendChallengeForm").addEventListener("submit", (event) => {
  event.preventDefault();

  // Get selected friends and other data from the form
  const selectedFriends = getSelectedFriends();

  // Generate URLs for each friend and send them
  selectedFriends.forEach(friend => {
    const challengeURL = generateChallengeURL(quizCode, challengeNumber);
    sendChallengeToFriend(challengeURL, friend);
  });

  // Display success message or update UI
});




// Function to send a challenge URL to a friend
function sendChallengeToFriend(quizCode,challengeURL, challengerID) {
  // Assuming you have a Firebase Firestore instance initialized
  const db = firebase.firestore();

  // Define challenge data
  const requestDate = new Date();

  // Fetch additional quiz information from the quizzes collection
  db.collection("quizzes")
    .doc(quizCode)
    .get()
    .then((quizDoc) => {
      if (quizDoc.exists) {
        const quizData = quizDoc.data();
        const quizName = quizData.quizName;
        const questionCount = quizData.numberOfQuestionsDB; // Assuming questions is an array in quizData

        // Add challenge data to the challenges collection
        db.collection("challenges").add({
          quizCode:quizCode,
          quizName:quizName,
          challengeNumber:challengeNumber,
          requestDate:requestDate,
          requesterID:uID,
	challengeStarted: false,	
          challengerID:challengerID,
          challengeDone: false, // Initial challenge status
          questionCount:questionCount, // Number of questions in the quiz
          // Add more relevant fields as needed
        })
        .then(() => {
          console.log("Challenge sent to friend successfully!");
        })
        .catch((error) => {
          console.error("Error sending challenge:", error);
        });
      } else {
        console.error("Quiz not found.");
      }
    })
    .catch((error) => {
      console.error("Error fetching quiz data:", error);
    });
}

async function getUserFriendsWithUserData(firebaseId) {
  try {

	  	  console.log("firebaseId :", firebaseId);

    // Fetch the user's friends from Firebase (replace this with your actual Firebase code)
    const friendsSnapshot = await firebase.firestore()
      .collection('friends')
      .where('user1', '==', firebaseId)
      .get();
	  
    const friends = friendsSnapshot.docs.map((doc) => doc.data().user2);

    // Fetch the user's data from the users collection for each friend
    const friendDataPromises = friends.map(async (friendId) => {
      const userSnapshot = await firebase.firestore()
        .collection('users')
        .doc(friendId)
        .get();
      return userSnapshot.data();
    });

    // Wait for all friend data to be fetched
    const friendDataArray = await Promise.all(friendDataPromises);

    console.log("friendDataArray :", friendDataArray);
    return { friends, friendData: friendDataArray };
  } catch (error) {
    console.error('Error getting user\'s friends and data:', error);
    return { friends: [], friendData: [] }; // Return empty array in case of an error
  }
}

window.addEventListener('load', async () => {
  // Get the user ID using the getUserInfo function (assuming you have implemented it)
 // const userInfo = getUserInfo();
//  const uID = userInfo.firebaseId;
	
    console.log("uID :", uID);
fetchAndDisplayChallenges(uID);
	getUserFriends(uID);  
	
});
	  
  </script>
</body>
</html>
