<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Friend</title>
	


  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="style.css">


  <!-- Import navbar and footer components -->
  <link rel="import" href="/elements/navbar.html">
  <link rel="import" href="/elements/footer.html">

  <div id="navbar"></div>
  <!-- Rest of the page content -->
  <div id="signupLoginArea"><div>

  <!-- JavaScript dependencies async -->


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"  crossorigin="anonymous">


  <script  defer src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.9.3/umd/popper.min.js"></script>

  <script  defer src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

	  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css">
	  <script  defer src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.0.2/js/bootstrap.min.js"></script>

  <!-- Firebase SDK -->
  <script  src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script  src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script  src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <!-- Custom scripts   <script  src="/main.js" defer></script> 
-->
  <script  src="/main.js" ></script> 

  <style>


    .input-wrapper {
      text-align: center;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      color: #fff;
      max-width: 80%;
    background-color: #fd7e14;
    }

    .input-wrapper h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }

    .input-wrapper {
    margin: 5% auto;
    }

    input {
      padding: 10px;
      font-size: 16px;
      width: 100%;
      border: none;
      border-radius: 5px;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    #message {
      margin-top: 10px;
    }
#friendsList{
    width: 100%;
    display: grid;
    margin: 0;
    padding: 0;
}

	  
.friends{
cursor: pointer;
font-size: 1.5em;
    font-weight: 500;
	width: 100%;
    color: #000;
    display: flex;
    justify-content: space-around;
    background-color: white;
    border: 1px solid #ced4da;
    border-radius: 4px;
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
    margin: 2% 0;
}
	  .picArea{
    border: 1px solid #fd7e14;
    border-radius: 5em;
    padding: 1%;
    overflow: hidden;
	  }

	  .points{
      font-weight: 800;
    margin: auto;
    width: 50%;
	  }
	  .remove{
    border: 1px solid #fd7e14;
    border-radius: 1em;
    padding: 1%;
    color: #fff;
    background-color: red;
    margin: auto;
    width: 20%;	  
	  }

	  .bg{
    border: 1px solid #ebebeb;
    border-radius: 1em;
    background-color: #f5f5f5;
    margin: 1%;
    width: 95%;
    display: flex;
    padding: 2%	  
	  }

	  .picWrap{
    width: 20%;
}
	 .picArea img {
    width: 100%;
    height: 100%;
}
  </style>
</head>

<body>
	    <div class="input-wrapper">
    <div id="message"></div>
 </div>
	
    <div class="input-wrapper">
      <input type="text" id="friendIdInput" placeholder="Enter friend's ID" />
 
    <button onclick="addFriendFromInput()">Add Friend</button>
   </div>
	


      <div class="input-wrapper">
        <ul id="friendsList">
          <!-- Dynamically generated list of friends -->
          <!-- Add your list of friends here or populate it dynamically using JavaScript -->

        </ul>
      </div>




	
 <div class="input-wrapper">
      <input type="text" id="userIdInput" placeholder="User ID" />
      <button onclick="copyFriendCodeToClipboard()">Auto Copy</button>
    </div>
	  
 


    <script>
	    		  const userInfo = getUserInfo();
  const currentUserFirebaseId = userInfo.firebaseId;
	    
      const userIdInput = document.getElementById("userIdInput");
	    userIdInput.value = "https://www.quizzatopia.com/friends/?"+currentUserFirebaseId;
		    
	       function copyFriendCodeToClipboard() {
      userIdInput.select();
      document.execCommand("copy");
    }
      // Function to add a friend from the input field
function addFriendFromInput() {
  const friendId = document.getElementById("friendIdInput").value.trim();

  // Call the addFriend function with the input friend's ID
  addFriend(currentUserFirebaseId, friendId);
}

// Function to add a friend
async function addFriend(currentUserFirebaseIdxx, friendFirebaseIdxx) {
  try {
    // Get a reference to the "friends" collection
    const friendsCollectionRef = firebase.firestore().collection("friends");
let currentUserFirebaseId = input(currentUserFirebaseIdxx);
let friendFirebaseId = input(friendFirebaseIdxx);

	  // Check if the friendship already exists


    if (friendFirebaseId === currentUserFirebaseId) {
      // Friendship already exists, show an error message
      const messageDiv = document.getElementById("message");
      messageDiv.innerText = "Oh No!";
      return;
    }
const today = new Date();
today.setHours(0, 0, 0, 0); // Set time to midnight for the current day

// Check if user1 has added more than 25 users on the current day
const user1AddedTodayQuery = await friendsCollectionRef
  .where("user1", "==", currentUserFirebaseId)
  .where("addDate", ">=", today)
  .get();

if (user1AddedTodayQuery.size >= 25) {
  // User1 has added more than 25 users today, show an error message
  const messageDiv = document.getElementById("message");
  messageDiv.innerText = "You have added too many friends today. Try again tomorrow.";
  return;
}

const existingFriendship = await friendsCollectionRef
  .where("user1", "==", currentUserFirebaseId)
  .where("user2", "==", friendFirebaseId)
  .get();

if (!existingFriendship.empty) {
  // Friendship already exists, show an error message
  const messageDiv = document.getElementById("message");
  messageDiv.innerText = "Send Your Link To A Friend!";
  return;
}

// Add the new friendship document to the "friends" collection
await friendsCollectionRef.add({
  user1: currentUserFirebaseId,
  user2: friendFirebaseId,
  addDate: today, // Use the server date here
});



	  
    if (!existingFriendship.empty) {
      // Friendship already exists, show an error message
      const messageDiv = document.getElementById("message");
      messageDiv.innerText = "Friendship already exists.";
      return;
    }

    // Show a success message
    const messageDiv = document.getElementById("message");
    messageDiv.innerText = "Friend added successfully.";
	  generateFriendsList();
  } catch (error) {
    // Show an error message
    console.error("Error adding friend:", error);
    const messageDiv = document.getElementById("message");
    messageDiv.innerText = "Error adding friend. Please try again later.";
  }
}


  function getURLParams() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams;
  }
	     
window.addEventListener('load', async () => {
  // Get the user ID using the getUserInfo function (assuming you have implemented it)
  const userInfo = getUserInfo();
  const uID = userInfo.firebaseId;


	    
  // Get the challenge number and friend ID from URL parameters
  const urlParams = getURLParams();
const friendID = urlParams.substring(1); // Exclude the leading '?' character

  // Log the values for testing
  console.log('friendID:', friendID);
  console.log('User ID:', uID);

  if (friendID === '' || friendID === null || friendID === undefined) {
    console.log('No friend ID in the URL, skipping database check.');
    return;
  }

  // Add friend
  await addFriend(input(uID), input(friendID));
});


async function generateFriendsList() {
  try {
    const { friends, userData } = await getUserFriendsWithUserData(userInfo.firebaseId);

 // Clear previous list items
document.getElementById("friendsList").innerHTML = '';

if (friends.length === 0) {
  document.getElementById("friendsList").innerHTML = `<div class='points'>Send Your Link to Your Friends</div>`;
}
    // Generate list items for each friend
      let friendsHTML = "";
    friends.forEach((friend) => {
      // Assuming userData contains properties 'userName', 'userProfilePic', and 'userPoints'
  const friendName = friend.userName;
  const friendPicture = friend.userProfilePic;
  const friendPoints = friend.userPoints;
  const friendFirebaseId = friend.firebaseId;

      // Create an image element with its source set to the friend's picture
      const imgElement = `<img src="${friendPicture}" alt="${friendName}" width="40" height="40">`;

      // Create a span element for the friend's points
      const name = `<span>${friendName}</span>`;
      const points = `<span>${friendPoints}</span>`;

      // Create the list item HTML with the friend's name, picture, and points
      const listItemHTML = `
        <li class='friends' ><div  class='bg'> 
        <div  class='picWrap' onclick="handleFriendClick('${friendName}', '${friendfirebaseId}')"> 
	<div class='picArea'> ${imgElement}</div>
         <div> ${name}</div></div>
         <div> </div>
         <div class='points'> ${points} Points</div>
         <div class='remove ' onclick=" removeFriend('${friendfirebaseId}');"> Remove</div>
	 </div>
        </li>
      `;

      // Concatenate the HTML for each friend
      friendsHTML += listItemHTML;
    });

    // Set the innerHTML of friendsList with the generated HTML
	  document.getElementById("friendsList").innerHTML = friendsHTML;
  } catch (error) {
    console.error('Error fetching friends and user data:', error);
  }
}


function handleFriendClick(friendName, friendfirebaseId) {
  // Add your logic to handle the click event here
  console.log("Friend clicked:", friendName);
  // For example, you can display more details about the friend or perform some action.
 
}



	  
// Function to remove a friend
async function removeFriend(friendFirebaseId) {
  try {
	    console.log("remove friendFirebaseId:", friendFirebaseId);

    // Get a reference to the "friends" collection
  const userInfo = getUserInfo();
  // Update the navigation ba
  const currentUserFirebaseId = userInfo.firebaseId;
	  	    console.log("currentUserFirebaseId:", currentUserFirebaseId);
const friendsCollectionRef = firebase.firestore().collection("friends");

/*
// Find the friendship documents where either user1 or user2 matches the current user or friend id
const friendshipQuery = await friendsCollectionRef
  .where("user1", "in", [currentUserFirebaseId, friendFirebaseId])
  .where("user2", "in", [currentUserFirebaseId, friendFirebaseId])
  .get();
*/
	  const friendshipQuery = await friendsCollectionRef
      .where("user1", "==", currentUserFirebaseId)
      .where("user2", "==", friendFirebaseId)
      .get();


    if (friendshipQuery.empty) {
      // Friendship does not exist, handle accordingly (e.g., show an error message)
      console.log("Friendship does not exist.");
      return;
    }

    // Delete each friendship document found in the query
    const deletePromises = friendshipQuery.docs.map((doc) => doc.ref.delete());
    await Promise.all(deletePromises);
	    generateFriendsList();

    console.log("Friend removed successfully.");
  } catch (error) {
    console.error("Error removing friend:", error);
  }
}

async function getUserFriendsWithUserData(firebaseId) {
  try {
    // Fetch the user's friends from Firebase (replace this with your actual Firebase code)
    const friendsSnapshot = await firebase.firestore()
      .collection('friends')
      .where('user1', '==', firebaseId)
      .get();

    // Fetch the user's data from the users collection
    const userSnapshot = await firebase.firestore()
      .collection('users')
      .doc(firebaseId)
      .get();

    const friends = friendsSnapshot.docs.map((doc) => doc.data().user2);
    const userData = userSnapshot.data(); // User's data from the users collection

    return { friends, userData };
  } catch (error) {
    console.error('Error getting user\'s friends and data:', error);
    return { friends: [], userData: null }; // Return empty array and null user data in case of an error
  }
}

	    generateFriendsList();
	    
    </script>
</body>
</html>
